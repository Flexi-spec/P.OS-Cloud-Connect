<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>P.OS | Secure Command</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com">
    <style>
        :root { --bg: #020617; --glass: rgba(15, 23, 42, 0.8); --accent: #3b82f6; }
        body { font-family: sans-serif; background: var(--bg); color: white; overflow: hidden; height: 100vh; }
        .glass { background: var(--glass); backdrop-filter: blur(25px); border: 1px solid rgba(255,255,255,0.1); }
        .bubble { max-width: 80%; padding: 12px; border-radius: 18px; font-size: 0.9rem; margin-bottom: 8px; }
        .mine { background: var(--accent); align-self: flex-end; border-bottom-right-radius: 2px; }
        .theirs { background: #1e293b; align-self: flex-start; border-bottom-left-radius: 2px; }
        
        /* Sidebar for Professor Only */
        #contact-sidebar { width: 300px; border-right: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; }
        body.guest-mode #contact-sidebar { display: none !important; }
    </style>
</head>
<body class="flex">

    <!-- PROFESSOR'S CONTACT LIST -->
    <aside id="contact-sidebar" class="bg-slate-950 p-6">
        <h2 class="text-xl font-black text-blue-500 mb-6">COMMAND</h2>
        <div class="mb-6">
            <input type="text" id="new-contact-name" placeholder="New Contact Name..." class="w-full bg-slate-900 p-3 rounded-xl mb-2 text-sm outline-none">
            <button onclick="createNewContact()" class="w-full bg-blue-600 p-3 rounded-xl font-bold text-xs">CREATE SECURE LINK</button>
        </div>
        <div id="contact-list" class="space-y-2 overflow-y-auto flex-1">
            <!-- Saved contacts will appear here -->
        </div>
    </aside>

    <!-- CHAT INTERFACE -->
    <main class="flex-1 flex flex-col relative">
        <header class="h-20 glass flex items-center justify-between px-8 border-b border-white/5">
            <div class="flex items-center gap-4">
                <div id="status-dot" class="w-3 h-3 bg-slate-500 rounded-full animate-pulse"></div>
                <div>
                    <h1 id="chat-with-name" class="font-bold text-lg">Select a Contact</h1>
                    <p id="online-status" class="text-[10px] text-slate-500 uppercase font-black">System Standby</p>
                </div>
            </div>
        </header>

        <div id="chat-box" class="flex-1 overflow-y-auto p-6 flex flex-col space-y-2 bg-[url('https://www.transparenttextures.com')]">
            <!-- Messages load here -->
        </div>

        <form id="chat-form" class="p-6 bg-slate-950/50 flex gap-4">
            <input type="text" id="msg-input" placeholder="Type encrypted message..." class="flex-1 bg-slate-900 border border-white/10 rounded-2xl px-6 py-4 outline-none">
            <button type="submit" class="w-14 h-14 bg-blue-600 rounded-2xl flex items-center justify-center shadow-lg shadow-blue-600/30">
                <i class="fas fa-paper-plane"></i>
            </button>
        </form>
    </main>

    <script>
        const PROF_NAME = "Professor";
        const params = new URLSearchParams(window.location.search);
        
        // This is the logic that separates David from Samuel
        // We use a "Room ID" which is a unique token generated for that person
        const activeRoom = params.get('room'); 
        const guestName = params.get('target'); // e.g. "David"

        const STATE = {
            currentUser: activeRoom ? guestName : PROF_NAME,
            isGuest: !!activeRoom,
            currentRoom: activeRoom || null
        };

        if (STATE.isGuest) {
            document.body.classList.add('guest-mode');
            document.getElementById('chat-with-name').innerText = `Welcome, ${guestName}`;
            document.getElementById('online-status').innerText = "Connected to Professor";
            document.getElementById('online-status').classList.add('text-emerald-500');
            document.getElementById('status-dot').classList.replace('bg-slate-500', 'bg-emerald-500');
        }

        // --- PROFESSOR: CREATE CONTACT ---
        function createNewContact() {
            const name = document.getElementById('new-contact-name').value.trim();
            if (!name) return;

            // Generate a truly unique room ID so Samuel and David never mix
            const uniqueRoom = `Room_${name}_${Math.floor(Math.random() * 8999 + 1000)}`;
            const secureLink = `${window.location.origin}${window.location.pathname}?room=${uniqueRoom}&target=${name}`;
            
            // Save to LocalStorage so Professor doesn't lose the list
            const contacts = JSON.parse(localStorage.getItem('myContacts') || '[]');
            contacts.push({ name, room: uniqueRoom, link: secureLink });
            localStorage.setItem('myContacts', JSON.stringify(contacts));
            
            document.getElementById('new-contact-name').value = '';
            loadContacts();
            alert(`Link created for ${name}! Copy it from your list.`);
        }

        function loadContacts() {
            const contacts = JSON.parse(localStorage.getItem('myContacts') || '[]');
            document.getElementById('contact-list').innerHTML = contacts.map(c => `
                <div class="p-4 glass rounded-2xl cursor-pointer hover:bg-blue-600/20 transition mb-2" onclick="openRoom('${c.room}', '${c.name}')">
                    <p class="font-bold text-sm">${c.name}</p>
                    <button onclick="navigator.clipboard.writeText('${c.link}'); event.stopPropagation(); alert('Link Copied')" class="text-[9px] text-blue-400 font-bold uppercase mt-1">Copy Invite Link</button>
                </div>
            `).join('');
        }

        function openRoom(roomID, name) {
            STATE.currentRoom = roomID;
            document.getElementById('chat-with-name').innerText = `Chat with ${name}`;
            document.getElementById('online-status').innerText = "Secure Channel Active";
            syncMessages();
        }

        // --- MESSAGING CORE ---
        async function syncMessages() {
            if (!STATE.currentRoom) return;
            try {
                const res = await fetch(`/api/messages?room=${STATE.currentRoom}`);
                const data = await res.json();
                const chatBox = document.getElementById('chat-box');
                
                chatBox.innerHTML = data.map(m => `
                    <div class="flex flex-col ${m.user === STATE.currentUser ? 'items-end' : 'items-start'}">
                        <div class="bubble ${m.user === STATE.currentUser ? 'mine' : 'theirs'}">
                            ${m.text}
                        </div>
                        <span class="text-[8px] opacity-30 px-2">${m.user} â€¢ ${m.time}</span>
                    </div>
                `).join('');
                chatBox.scrollTop = chatBox.scrollHeight;
            } catch (e) {}
        }

        document.getElementById('chat-form').onsubmit = async (e) => {
            e.preventDefault();
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if (!text || !STATE.currentRoom) return;

            input.value = '';
            await fetch(`/api/messages?room=${STATE.currentRoom}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user: STATE.currentUser, text })
            });
            syncMessages();
        };

        if (!STATE.isGuest) loadContacts();
        setInterval(syncMessages, 3000);
    </script>
</body>
</html>
