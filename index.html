<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>P.OS | Secure Command</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com">
    <style>
        :root { --blue-glow: #3b82f6; --glass: rgba(15, 23, 42, 0.6); }
        body { 
            background: radial-gradient(circle at top right, #1e293b, #020617);
            color: #f8fafc; font-family: sans-serif; height: 100vh; overflow: hidden;
        }
        .glass-card { 
            background: var(--glass); backdrop-filter: blur(25px); 
            border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 30px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.8);
        }
        .neon-text { text-shadow: 0 0 10px var(--blue-glow); }
        .bubble { max-width: 80%; padding: 12px 16px; border-radius: 20px; font-size: 0.9rem; margin-bottom: 8px; }
        .mine { background: linear-gradient(135deg, #2563eb, #1d4ed8); align-self: flex-end; border-bottom-right-radius: 4px; }
        .theirs { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); align-self: flex-start; border-bottom-left-radius: 4px; }
        
        /* Restricted Access Overlay */
        body.guest-view .admin-only { display: none !important; }
    </style>
</head>
<body class="flex flex-col md:flex-row p-4 md:p-8 gap-6">

    <!-- LEFT: CONTACT CONTROL (ADMIN ONLY) -->
    <aside class="admin-only w-full md:w-80 space-y-6">
        <div class="glass-card p-6">
            <h1 class="text-2xl font-black text-blue-500 neon-text mb-4">COMMAND</h1>
            <div class="space-y-4">
                <p class="text-[10px] uppercase font-bold text-slate-500">Create Secure Link</p>
                <input id="contactName" type="text" placeholder="Enter Contact Name..." class="w-full bg-slate-900/50 border border-blue-500/30 rounded-xl p-3 text-sm outline-none focus:ring-1 ring-blue-500">
                <button onclick="generateSecureLink()" class="w-full bg-blue-600 hover:bg-blue-500 py-3 rounded-xl font-bold text-sm transition shadow-lg shadow-blue-500/20">GENERATE LINK</button>
            </div>
        </div>
        <div class="glass-card p-6 flex items-center justify-between">
            <span class="text-xs font-bold uppercase tracking-widest">System Status</span>
            <div id="online-pulse" class="h-2 w-2 bg-emerald-500 rounded-full animate-pulse shadow-[0_0_10px_#10b981]"></div>
        </div>
    </aside>

    <!-- RIGHT: CHAT CORE -->
    <main class="flex-1 glass-card flex flex-col overflow-hidden relative">
        <header class="p-6 border-b border-white/5 flex items-center justify-between bg-white/5">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center font-bold">MO</div>
                <div>
                    <h2 id="chatHeading" class="font-bold text-white uppercase tracking-tighter">SECURE CHANNEL</h2>
                    <p id="statusLabel" class="text-[10px] text-emerald-500 font-bold uppercase">Ready for Sync</p>
                </div>
            </div>
            <i class="fas fa-ellipsis-vertical text-slate-500"></i>
        </header>

        <div id="msgBox" class="flex-1 overflow-y-auto p-6 flex flex-col gap-2">
            <!-- Messages Load Here -->
        </div>

        <form id="chatForm" class="p-4 bg-slate-950/50 border-t border-white/5 flex gap-3">
            <input id="chatInput" type="text" placeholder="Transmit secure data..." autocomplete="off" class="flex-1 bg-transparent border-none p-2 text-white outline-none">
            <button type="submit" class="bg-blue-600 w-12 h-12 rounded-2xl shadow-lg shadow-blue-600/30 transition hover:scale-105 active:scale-95">
                <i class="fas fa-paper-plane"></i>
            </button>
        </form>
    </main>

    <script>
        const params = new URLSearchParams(window.location.search);
        const ROOM = params.get('id') || 'Global';
        const GUEST_NAME = params.get('name'); // The name she saved the person as
        const IS_ADMIN = !GUEST_NAME;
        const MY_NAME = IS_ADMIN ? "Professor" : GUEST_NAME;

        if (!IS_ADMIN) {
            document.body.classList.add('guest-view');
            document.getElementById('chatHeading').innerText = `WELCOME, ${GUEST_NAME}`;
            document.getElementById('statusLabel').innerText = "LINK ESTABLISHED BY PROFESSOR";
        }

        // 1. GENERATE LINK FOR DAVID
        function generateSecureLink() {
            const name = document.getElementById('contactName').value;
            if(!name) return alert("Enter a name!");
            const uniqueID = "SEC-" + Math.random().toString(36).substr(2, 5);
            const secureURL = `${window.location.origin}${window.location.pathname}?id=${uniqueID}&name=${name}`;
            
            navigator.clipboard.writeText(secureURL);
            alert(`Link generated for ${name}! Copied to clipboard.`);
        }

        // 2. REAL-TIME JSON SYNC
        async function sync() {
            try {
                const res = await fetch(`/api/messages?room=${ROOM}`);
                const data = await res.json();
                const box = document.getElementById('msgBox');
                
                // Track for notifications
                if (IS_ADMIN && data.length > localStorage.getItem('lastCount')) {
                    const last = data[data.length-1];
                    if(last.user !== MY_NAME) pushNotif(last.user, last.text);
                }
                localStorage.setItem('lastCount', data.length);

                box.innerHTML = data.map(m => `
                    <div class="flex flex-col ${m.user === MY_NAME ? 'items-end' : 'items-start'}">
                        <span class="text-[9px] font-black text-slate-500 uppercase px-2 mb-1">${m.user}</span>
                        <div class="bubble ${m.user === MY_NAME ? 'mine' : 'theirs'}">${m.text}</div>
                    </div>
                `).join('');
                box.scrollTop = box.scrollHeight;
            } catch(e) {}
        }

        // 3. SEND MESSAGE
        document.getElementById('chatForm').onsubmit = async (e) => {
            e.preventDefault();
            const input = document.getElementById('chatInput');
            const text = input.value;
            if(!text) return;
            input.value = '';

            await fetch(`/api/messages?room=${ROOM}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ user: MY_NAME, text })
            });
            sync();
        };

        function pushNotif(user, text) {
            if (Notification.permission === "granted") {
                new Notification(`Message from ${user}`, { body: text });
            }
        }

        Notification.requestPermission();
        setInterval(sync, 2500);
        sync();
    </script>
</body>
</html>
