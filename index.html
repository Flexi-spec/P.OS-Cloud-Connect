<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>THE PROPRIETRESS OS</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root { --bg-deep: #020617; --accent: #3b82f6; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg-deep); color: #f8fafc; overflow: hidden; height: 100vh; }
        .glass { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.05); }
        .sidebar { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); z-index: 50; }
        
        /* Guest Mode Lockdown */
        body.guest-mode .sidebar, body.guest-mode nav, body.guest-mode header { display: none !important; }
        body.guest-mode main { width: 100vw !important; padding: 0 !important; }
        body.guest-mode #view-messenger { display: flex !important; height: 100vh; width: 100%; }

        #map { height: 400px; border-radius: 24px; z-index: 10; }
        .chat-bubble { max-width: 85%; padding: 12px 18px; border-radius: 22px; font-size: 0.9rem; animation: slideUp 0.3s ease; }
        .bubble-in { background: #1e293b; border-bottom-left-radius: 4px; align-self: flex-start; }
        .bubble-out { background: #2563eb; border-bottom-right-radius: 4px; align-self: flex-end; }
        
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .tab-view { display: none; height: 100%; overflow-y: auto; }
        .tab-view.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="flex flex-col md:flex-row">

    <aside id="sidebar" class="sidebar w-80 bg-slate-950 border-r border-white/5 flex flex-col justify-between p-8">
        <div>
            <h1 class="text-2xl font-black text-blue-500 tracking-tighter mb-10">PROPRIETRESS</h1>
            <nav class="space-y-2">
                <button onclick="navTo('dash')" class="w-full flex items-center gap-4 px-6 py-4 rounded-2xl bg-blue-600/10 text-blue-400 border border-blue-500/20">
                    <i class="fas fa-gauge-high"></i> <span class="font-bold">Command</span>
                </button>
                <button onclick="navTo('messenger')" class="w-full flex items-center gap-4 px-6 py-4 rounded-2xl text-slate-400 hover:bg-white/5">
                    <i class="fas fa-comment-nodes"></i> <span class="font-bold">Chat</span>
                </button>
                <button onclick="navTo('travel')" class="w-full flex items-center gap-4 px-6 py-4 rounded-2xl text-slate-400 hover:bg-white/5">
                    <i class="fas fa-map-location-dot"></i> <span class="font-bold">Map</span>
                </button>
            </nav>
        </div>
        <div class="glass p-5 rounded-3xl">
            <p id="os-time" class="text-2xl font-mono font-bold text-white">00:00:00</p>
            <p id="os-weather" class="text-[10px] text-slate-500 mt-1 uppercase">Syncing Metro...</p>
        </div>
    </aside>

    <main class="flex-1 relative overflow-hidden">
        
        <section id="view-dash" class="tab-view active p-8 md:p-16">
            <h2 class="text-5xl font-black mb-8">Executive <span class="text-blue-500">Brief</span></h2>
            <div id="news-ticker" class="glass p-6 rounded-3xl border-l-4 border-emerald-500 mb-8 animate-pulse text-sm italic">
                Scanning global news feeds...
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="glass p-8 rounded-[40px]">
                    <p class="text-xs font-black text-blue-500 uppercase mb-2">Network Status</p>
                    <h3 class="text-2xl font-bold text-white">Secure Link Ready</h3>
                    <button onclick="shareInviteLink()" class="mt-4 px-6 py-3 bg-blue-600 rounded-xl text-sm font-bold hover:scale-105 transition">GENERATE GUEST LINK</button>
                </div>
            </div>
        </section>

        <section id="view-messenger" class="tab-view p-4 md:p-8 flex flex-col h-full">
            <div class="flex-1 glass rounded-[40px] flex flex-col overflow-hidden">
                <div class="p-6 border-b border-white/5 flex justify-between items-center">
                    <h3 class="font-black tracking-widest text-blue-500">SECURE CHANNEL</h3>
                    <span class="text-[10px] bg-emerald-500/20 text-emerald-400 px-3 py-1 rounded-full">ENCRYPTED</span>
                </div>
                <div id="chat-container" class="flex-1 overflow-y-auto p-6 space-y-4 flex flex-col"></div>
                <form id="messenger-form" class="p-4 bg-slate-900/50 flex gap-2">
                    <input type="text" id="m-input" placeholder="Type message..." class="flex-1 bg-slate-800 rounded-2xl px-6 py-4 outline-none text-white border border-white/5">
                    <button type="submit" class="w-14 h-14 bg-blue-600 rounded-2xl"><i class="fas fa-paper-plane"></i></button>
                </form>
            </div>
        </section>

        <section id="view-travel" class="tab-view p-8">
            <div class="flex gap-4 mb-6">
                <input type="text" id="map-search" placeholder="Search location..." class="flex-1 bg-slate-800 p-4 rounded-xl outline-none">
                <button onclick="searchMap()" class="px-8 bg-emerald-600 rounded-xl font-bold">LOCATE</button>
            </div>
            <div id="map"></div>
        </section>

    </main>

    <script>
        const APP_STATE = {
            user: "Executive",
            room: new URLSearchParams(window.location.search).get('room') || 'Global-Admin',
            isGuest: new URLSearchParams(window.location.search).get('view') === 'guest'
        };

        // 1. GUEST LOCKDOWN LOGIC
        if (APP_STATE.isGuest) {
            document.body.classList.add('guest-mode');
            APP_STATE.user = "Guest";
            document.getElementById('view-messenger').classList.add('active');
        }

        // 2. LEAFLET MAP INITIALIZATION
        let map = L.map('map').setView([7.4913, 4.5244], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap'
        }).addTo(map);
        let marker = L.marker([7.4913, 4.5244]).addTo(map);

        async function searchMap() {
            const query = document.getElementById('map-search').value;
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}`);
            const data = await res.json();
            if (data.length > 0) {
                const { lat, lon } = data[0];
                map.setView([lat, lon], 13);
                marker.setLatLng([lat, lon]);
            }
        }

        // 3. SECURE GUEST LINK GENERATOR
        function shareInviteLink() {
            const token = Math.random().toString(36).substring(2, 15);
            const guestURL = `${window.location.origin}${window.location.pathname}?room=${token}&view=guest`;
            navigator.clipboard.writeText(guestURL);
            alert("SECURE GUEST LINK COPIED!\nShe will only see the chat, not your dashboard.");
        }

        // 4. METRO WEATHER & NEWS
        async function syncData() {
            // Weather
            try {
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=7.49&longitude=4.52&current_weather=true`);
                const data = await res.json();
                document.getElementById('os-weather').innerText = `IFE: ${data.current_weather.temperature}°C • OPTIMAL`;
            } catch(e) {}

            // News Ticker
            try {
                const res = await fetch('https://api.spaceflightnewsapi.net/v4/articles/?limit=1');
                const data = await res.json();
                document.getElementById('news-ticker').innerText = `INTEL: ${data.results[0].title}`;
            } catch(e) {}
        }

        // 5. CHAT SYSTEM (Connects to your Vercel KV API)
        async function fetchMessages() {
            try {
                const res = await fetch(`/api/messages?room=${APP_STATE.room}`);
                const msgs = await res.json();
                const container = document.getElementById('chat-container');
                container.innerHTML = msgs.map(m => `
                    <div class="flex flex-col ${m.user === APP_STATE.user ? 'items-end' : 'items-start'}">
                        <div class="chat-bubble ${m.user === APP_STATE.user ? 'bubble-out' : 'bubble-in'}">
                            ${m.text}
                        </div>
                    </div>
                `).join('');
                container.scrollTop = container.scrollHeight;
            } catch (e) {}
        }

        document.getElementById('messenger-form').onsubmit = async (e) => {
            e.preventDefault();
            const input = document.getElementById('m-input');
            if (!input.value) return;
            await fetch(`/api/messages?room=${APP_STATE.room}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user: APP_STATE.user, text: input.value })
            });
            input.value = '';
            fetchMessages();
        };

        // Init
        function navTo(id) {
            document.querySelectorAll('.tab-view').forEach(t => t.classList.remove('active'));
            document.getElementById('view-' + id).classList.add('active');
            if (id === 'travel') setTimeout(() => map.invalidateSize(), 100);
        }

        setInterval(() => {
            document.getElementById('os-time').innerText = new Date().toLocaleTimeString('en-GB');
            fetchMessages();
        }, 3000);
        
        syncData();
        fetchMessages();
    </script>
</body>
</html>
