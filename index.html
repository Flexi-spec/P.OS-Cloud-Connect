<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Azin Messenger | Secure Link Chat</title>
    
    <!-- PWA Setup -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="manifest" href="/manifest.json">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com">
    <link href="https://fonts.googleapis.com" rel="stylesheet">

    <style>
        :root { --bg: #0b141a; --header: #111b21; --chat-bg: #0b141a; --bubble-out: #005c4b; --bubble-in: #202c33; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: #e9edef; margin: 0; overflow: hidden; height: 100vh; }
        
        /* Chat Layout */
        #chat-window { height: calc(100vh - 130px); overflow-y: auto; scroll-behavior: smooth; background-image: url('https://user-images.githubusercontent.com'); background-blend-mode: overlay; background-color: var(--chat-bg); }
        
        /* Bubbles */
        .bubble { max-width: 75%; padding: 8px 12px; border-radius: 8px; font-size: 0.95rem; line-height: 1.4; position: relative; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); animation: fadeIn 0.2s ease; }
        .bubble.mine { background: var(--bubble-out); align-self: flex-end; border-top-right-radius: 0; }
        .bubble.theirs { background: var(--bubble-in); align-self: flex-start; border-top-left-radius: 0; }
        
        .time { font-size: 0.65rem; color: rgba(255,255,255,0.5); float: right; margin-top: 4px; margin-left: 8px; }
        .sender-name { font-size: 0.75rem; font-weight: 700; color: #34b7f1; display: block; margin-bottom: 2px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Input Area */
        #input-area { background: #202c33; padding: 10px 16px; display: flex; align-items: center; gap: 12px; position: fixed; bottom: 0; width: 100%; }
        input { flex: 1; background: #2a3942; border: none; color: white; padding: 10px 15px; border-radius: 8px; outline: none; }
        
        /* Custom Scrollbar */
        #chat-window::-webkit-scrollbar { width: 6px; }
        #chat-window::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); }
    </style>
</head>
<body class="flex flex-col">

    <!-- TOP NAV -->
    <header class="h-16 bg-[#111b21] flex items-center justify-between px-4 border-b border-white/5 z-10">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-slate-600 rounded-full flex items-center justify-center font-bold text-white overflow-hidden">
                <img id="room-avatar" src="https://ui-avatars.com" alt="">
            </div>
            <div>
                <h1 id="room-title" class="text-sm font-bold">Secure Chat</h1>
                <p class="text-[10px] text-emerald-500 font-bold uppercase tracking-widest">Online â€¢ Encrypted</p>
            </div>
        </div>
        <div class="flex gap-4 text-slate-400">
            <button onclick="shareLink()"><i class="fas fa-user-plus"></i></button>
            <button onclick="location.reload()"><i class="fas fa-sync-alt"></i></button>
        </div>
    </header>

    <!-- MESSAGES AREA -->
    <div id="chat-window" class="flex flex-col p-4 gap-3">
        <!-- Messages will load here -->
    </div>

    <!-- INPUT AREA -->
    <form id="chat-form">
        <div id="input-area">
            <button type="button" class="text-slate-400 text-xl"><i class="far fa-face-smile"></i></button>
            <input type="text" id="msg-input" placeholder="Type a message" autocomplete="off">
            <button type="submit" id="send-btn" class="text-emerald-500 text-xl px-2">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </form>

    <script>
        const PARAMS = new URLSearchParams(window.location.search);
        const CONFIG = {
            room: PARAMS.get('room') || 'Global-Lounge',
            user: localStorage.getItem('username') || ('User' + Math.floor(Math.random() * 999)),
            endpoint: '/api/messages'
        };

        // Initialize User
        if (!localStorage.getItem('username')) {
            localStorage.setItem('username', CONFIG.user);
        }

        document.getElementById('room-title').innerText = CONFIG.room;
        document.getElementById('room-avatar').src = `https://ui-avatars.com{CONFIG.room}&background=005c4b&color=fff`;

        // 1. Fetch & Render Messages
        async function syncChat() {
            try {
                const res = await fetch(`${CONFIG.endpoint}?room=${CONFIG.room}`);
                const messages = await res.json();
                const container = document.getElementById('chat-window');
                
                const isAtBottom = container.scrollHeight - container.scrollTop <= container.clientHeight + 100;

                container.innerHTML = messages.map(m => `
                    <div class="bubble ${m.user === CONFIG.user ? 'mine' : 'theirs'}">
                        ${m.user !== CONFIG.user ? `<span class="sender-name">${m.user}</span>` : ''}
                        ${m.text}
                        <span class="time">${m.time}</span>
                    </div>
                `).join('');

                if (isAtBottom) container.scrollTop = container.scrollHeight;
            } catch (err) { console.error("Sync lost..."); }
        }

        // 2. Send Message
        document.getElementById('chat-form').onsubmit = async (e) => {
            e.preventDefault();
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if (!text) return;

            input.value = ''; // Instant clear
            
            await fetch(`${CONFIG.endpoint}?room=${CONFIG.room}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user: CONFIG.user, text })
            });
            syncChat();
        };

        // 3. Share Link
        function shareLink() {
            const inviteUrl = `${window.location.origin}${window.location.pathname}?room=${CONFIG.room}`;
            navigator.clipboard.writeText(inviteUrl);
            alert("Chat Link Copied! Send it to anyone to start chatting in this room.");
        }

        // Start polling
        setInterval(syncChat, 2500);
        syncChat();
    </script>
</body>
</html>
